name: Update Decky Store

on:
  push:
    tags:
      - 'v*'

jobs:
  update-store:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout plugin repo
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Decky Plugin Database
        env:
          GH_TOKEN: ${{ secrets.STORE_SUBMISSION_TOKEN }}
          PLUGIN_NAME: xone-driver-manager
          BASE_REPO: SteamDeckHomebrew/decky-plugin-database
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "::warning::STORE_SUBMISSION_TOKEN not set. Skipping automated store update."
            exit 0
          fi

          # Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Fork and clone the official database repository
          echo "Forking and cloning $BASE_REPO..."
          gh repo fork "$BASE_REPO" --clone --remote
          cd decky-plugin-database

          # Create a new branch for the update
          BRANCH_NAME="update/$PLUGIN_NAME-v${{ steps.get_version.outputs.VERSION }}"
          echo "Creating branch $BRANCH_NAME..."
          git checkout -b "$BRANCH_NAME"

          # Update the submodule to the new tag
          # This assumes the submodule has already been added manually the first time
          echo "Updating submodule $PLUGIN_NAME to v${{ steps.get_version.outputs.VERSION }}..."
          git submodule update --init "plugins/$PLUGIN_NAME"
          cd "plugins/$PLUGIN_NAME"
          git fetch origin --tags
          git checkout "v${{ steps.get_version.outputs.VERSION }}"
          cd ../..

          # Commit and push the submodule update
          git add "plugins/$PLUGIN_NAME"
          git commit -m "Update $PLUGIN_NAME to v${{ steps.get_version.outputs.VERSION }}"

          echo "Pushing changes to fork..."
          git push origin "$BRANCH_NAME"

          # Create the Pull Request to the official database repo
          echo "Creating Pull Request..."
          gh pr create \
            --title "Update $PLUGIN_NAME to v${{ steps.get_version.outputs.VERSION }}" \
            --body "Automated update for $PLUGIN_NAME version ${{ steps.get_version.outputs.VERSION }}." \
            --repo "$BASE_REPO" \
            --base main \
            --head "$GITHUB_ACTOR:$BRANCH_NAME"
